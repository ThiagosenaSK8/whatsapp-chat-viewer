<aside class="w-full sm:w-64 md:w-72 lg:w-80 bg-white border-r border-gray-200 flex flex-col h-full flex-shrink-0 
              fixed lg:relative inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 
              transition-transform duration-300 ease-in-out z-40 lg:z-auto
              responsive-transition" id="sidebar">
    <!-- Mobile menu header -->
    <div class="lg:hidden p-3 border-b border-gray-200 bg-whatsapp-dark-green text-white flex items-center justify-between">
        <h2 class="font-semibold text-sm">Menu</h2>
        <button onclick="closeMobileSidebar()" class="p-1 hover:bg-whatsapp-green rounded">
            <i class="ri-close-line text-lg"></i>
        </button>
    </div>
    
    <!-- Header -->
    <div class="p-3 sm:p-4 border-b border-gray-200 bg-whatsapp-dark-green text-white flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-whatsapp-green rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="ri-user-line text-white text-lg sm:text-xl"></i>
                </div>
                <div class="min-w-0 flex-1">
                    <h2 class="font-semibold text-xs sm:text-sm truncate">{{ current_user.email }}</h2>
                    <p class="text-xs opacity-80 truncate hidden sm:block">WhatsApp Chat Viewer</p>
                </div>
            </div>
            <button onclick="logout()" class="p-1.5 sm:p-2 hover:bg-whatsapp-green rounded-lg transition-colors flex-shrink-0">
                <i class="ri-logout-box-line text-base sm:text-lg"></i>
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="p-1.5 sm:p-2 border-b border-gray-200 flex-shrink-0">
        <div class="grid grid-cols-2 gap-1 mb-1.5 sm:mb-2">
            <!-- Linha 1: Dashboard e Chat -->
            <a href="{{ url_for('templates.dashboard') }}" 
               class="nav-item flex items-center justify-center py-2 px-2 sm:px-3 rounded-lg transition-colors
                      {% if request.endpoint == 'templates.dashboard' %}bg-whatsapp-green text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                <i class="ri-dashboard-line text-sm sm:text-base sm:mr-2"></i>
                <span class="text-xs sm:text-sm font-medium hidden sm:inline">Dashboard</span>
            </a>
            <a href="{{ url_for('templates.chat') }}" 
               class="nav-item flex items-center justify-center py-2 px-2 sm:px-3 rounded-lg transition-colors
                      {% if request.endpoint == 'templates.chat' %}bg-whatsapp-green text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                <i class="ri-chat-3-line text-sm sm:text-base sm:mr-2"></i>
                <span class="text-xs sm:text-sm font-medium hidden sm:inline">Chat</span>
            </a>
        </div>
        <div class="grid grid-cols-2 gap-1">
            <!-- Linha 2: Analytics e Settings -->
            <a href="{{ url_for('templates.analytics') }}" 
               class="nav-item flex items-center justify-center py-2 px-2 sm:px-3 rounded-lg transition-colors
                      {% if request.endpoint == 'templates.analytics' %}bg-whatsapp-green text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                <i class="ri-bar-chart-line text-sm sm:text-base sm:mr-2"></i>
                <span class="text-xs sm:text-sm font-medium hidden sm:inline">Analytics</span>
            </a>
            <a href="{{ url_for('templates.settings') }}" 
               class="nav-item flex items-center justify-center py-2 px-2 sm:px-3 rounded-lg transition-colors
                      {% if request.endpoint == 'templates.settings' %}bg-whatsapp-green text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                <i class="ri-settings-line text-sm sm:text-base sm:mr-2"></i>
                <span class="text-xs sm:text-sm font-medium hidden sm:inline">Config</span>
            </a>
        </div>
    </nav>

    <!-- Phone Numbers Section - Only show on chat page -->
    {% if request.endpoint == 'templates.chat' %}
        <!-- Phone Numbers Section -->
    <div class="flex-1 flex flex-col p-2 sm:p-3">
        <div class="mb-2 sm:mb-3 space-y-2 sm:space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 min-w-0">
                    <h3 class="font-semibold text-gray-800 text-sm sm:text-base truncate">Números</h3>
                    <span id="phone-count" class="px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full flex-shrink-0">0</span>
                </div>
                <button onclick="showAddPhoneModal()" 
                        class="p-1 sm:p-1.5 text-whatsapp-green hover:bg-whatsapp-green hover:text-white rounded-lg transition-colors flex-shrink-0">
                    <i class="ri-add-line text-base sm:text-lg"></i>
                </button>
            </div>
            <div class="relative">
                <input type="text" 
                       id="phone-search" 
                       placeholder="Buscar..." 
                       class="w-full px-2.5 sm:px-3 py-1.5 sm:py-2 pr-7 sm:pr-8 text-xs sm:text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:border-transparent">
                <i class="ri-search-line absolute right-2 sm:right-3 top-2 sm:top-2.5 text-gray-400 pointer-events-none text-sm sm:text-base"></i>
            </div>
        </div>

        <!-- Virtual Scrolling List -->
        <div class="flex-1 overflow-hidden relative" id="phone-list-container">
            <div class="h-full overflow-y-auto custom-scrollbar" id="phone-list-scroll">
                <div id="phone-list">
                    <!-- Loading State -->
                    <div id="loading-state" class="p-4 text-center text-gray-500">
                        <i class="ri-loader-4-line animate-spin text-2xl mb-2"></i>
                        <p class="text-sm">Carregando números...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Phone Modal -->
    <div id="add-phone-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-lg w-full max-w-sm sm:max-w-md mx-2 sm:mx-4 transform transition-all">
            <div class="p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-900">Adicionar Número</h3>
                    <button onclick="hideAddPhoneModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="ri-close-line text-lg sm:text-xl"></i>
                    </button>
                </div>
                <form onsubmit="addPhone(event)">
                    <div class="mb-4">
                        <label for="new-phone-number" class="block text-sm font-medium text-gray-700 mb-2">
                            Número do WhatsApp
                        </label>
                        <input type="tel" 
                               id="new-phone-number" 
                               placeholder="+5511999999999" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:border-transparent"
                               required>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" 
                                onclick="hideAddPhoneModal()" 
                                class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            Cancelar
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-whatsapp-green text-white rounded-lg hover:bg-whatsapp-dark-green transition-colors font-medium">
                            Adicionar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Non-chat page content -->
    {% if request.endpoint != 'templates.chat' %}
    <div class="flex-1 p-4">
        <div class="text-center text-gray-500">
            <i class="ri-chat-off-line text-4xl mb-3 text-gray-300"></i>
            <p class="text-sm">
                {% if request.endpoint == 'templates.dashboard' %}
                Acesse a seção <strong>Chat</strong> para gerenciar seus números do WhatsApp.
                {% elif request.endpoint == 'templates.analytics' %}
                Os números do WhatsApp estão disponíveis apenas na seção <strong>Chat</strong>.
                {% elif request.endpoint == 'templates.settings' %}
                Para configurar números, acesse a seção <strong>Chat</strong>.
                {% else %}
                Seção de números disponível apenas no <strong>Chat</strong>.
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Delete Confirmation Modal (always available) -->
    {% include 'components/modals/delete_phone_modal.html' %}
</aside>

<script>
let selectedPhone = null;
let allPhones = [];
let filteredPhones = [];
let isLoading = false;
let deletePhoneId = null;
let deletePhoneNumber = null;

// Performance optimization for large lists
const BATCH_SIZE = 20;
const SCROLL_THRESHOLD = 100;
let renderedCount = 0;
let isRendering = false;

// Load phone numbers on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on chat page to setup phone functionality
    const currentPage = window.location.pathname.split('/').pop() || 'dashboard';
    
    if (currentPage === 'chat' || window.location.pathname === '/chat') {
        loadPhoneNumbers();
        setupEventListeners();
        setupVirtualScrolling();
    } else {
        // For non-chat pages, just setup basic functionality
        setupDeleteModalEvents(); // Delete modal should work everywhere
    }
});

function setupEventListeners() {
    // Search functionality with debounce (only if element exists)
    const searchInput = document.getElementById('phone-search');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterPhoneNumbers(e.target.value);
            }, 300);
        });
    }
    
    // Setup delete modal events (always available)
    setupDeleteModalEvents();
}

function setupVirtualScrolling() {
    const scrollContainer = document.getElementById('phone-list-scroll');
    if (!scrollContainer) return; // Exit if element doesn't exist
    
    let scrollTimeout;
    
    scrollContainer.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            checkAndLoadMoreItems();
        }, 100);
    });
}

async function loadPhoneNumbers() {
    if (isLoading) return;
    
    // Check if we have the necessary DOM elements (phone list container)
    const phoneListContainer = document.getElementById('phone-list');
    if (!phoneListContainer) {
        console.log('Phone list container not found, skipping phone numbers loading');
        return;
    }
    
    isLoading = true;
    
    try {
        console.log("Loading phone numbers...");
        const response = await fetch('/chat/phones');
        const data = await response.json();
        
        if (data.success) {
            allPhones = data.phones;
            filteredPhones = [...allPhones];
            
            console.log(`Loaded ${allPhones.length} phone numbers`);
            updatePhoneCount(allPhones.length);
            
            // Reset rendering
            renderedCount = 0;
            renderPhoneNumbers(true);
        } else {
            showToast('Erro ao carregar números', 'error');
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading phone numbers:', error);
        showToast('Erro ao carregar números', 'error');
        showEmptyState();
    } finally {
        isLoading = false;
    }
}

function renderPhoneNumbers(reset = false) {
    if (isRendering) return;
    isRendering = true;
    
    const phoneList = document.getElementById('phone-list');
    
    if (reset) {
        phoneList.innerHTML = '';
        renderedCount = 0;
    }
    
    if (filteredPhones.length === 0) {
        showEmptyState();
        isRendering = false;
        return;
    }
    
    // Remove loading state
    const loadingState = document.getElementById('loading-state');
    if (loadingState) {
        loadingState.remove();
    }
    
    // Calculate items to render
    const startIndex = reset ? 0 : renderedCount;
    const endIndex = Math.min(startIndex + BATCH_SIZE, filteredPhones.length);
    
    // Create document fragment for better performance
    const fragment = document.createDocumentFragment();
    
    for (let i = startIndex; i < endIndex; i++) {
        const phone = filteredPhones[i];
        const phoneElement = createPhoneElement(phone);
        fragment.appendChild(phoneElement);
    }
    
    phoneList.appendChild(fragment);
    renderedCount = endIndex;
    
    console.log(`Rendered ${renderedCount}/${filteredPhones.length} phone numbers`);
    
    isRendering = false;
}

function createPhoneElement(phone) {
    // Validate phone data with safe defaults
    const phoneId = phone.id || 0;
    const phoneNumber = phone.number || '';
    const phoneAiActive = phone.ai_active || false;
    
    // Skip invalid phones
    if (!phoneNumber || phoneId <= 0) {
        console.warn('Invalid phone data:', phone);
        return document.createElement('div'); // Return empty div
    }
    
    const phoneDiv = document.createElement('div');
    phoneDiv.className = 'phone-item border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors group';
    phoneDiv.setAttribute('data-phone', phoneNumber);
    phoneDiv.setAttribute('data-phone-id', phoneId.toString());
    phoneDiv.onclick = () => selectPhone(phoneNumber, phoneId);
    
    const formattedDate = phone.created_at ? new Date(phone.created_at).toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit'
    }) : 'N/A';
    
    const lastFourDigits = phoneNumber.length >= 4 ? phoneNumber.slice(-4) : phoneNumber.slice(0, 2) || '??';
    
    phoneDiv.innerHTML = `
        <div class="p-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <!-- Avatar -->
                    <div class="w-10 h-10 bg-gradient-to-r from-whatsapp-green to-whatsapp-dark-green rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white text-xs font-medium">${escapeHtml(lastFourDigits)}</span>
                    </div>
                    
                    <!-- Phone Info -->
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-gray-900 truncate text-sm">${escapeHtml(phoneNumber)}</h4>
                        <div class="flex items-center space-x-2 text-xs text-gray-500 mt-0.5">
                            <span class="flex items-center space-x-1">
                                <i class="ri-robot-line text-xs" aria-hidden="true"></i>
                                <span>${phoneAiActive ? 'IA Ativa' : 'IA Inativa'}</span>
                            </span>
                            <span class="w-1 h-1 bg-gray-400 rounded-full" aria-hidden="true"></span>
                            <span>${escapeHtml(formattedDate)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity" role="group" aria-label="Ações do número">
                    <!-- AI Toggle -->
                    <button onclick="toggleAI(event, ${phoneId})" 
                            class="ai-toggle p-1.5 rounded-lg transition-colors text-xs focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:ring-offset-1 ${phoneAiActive ? 'bg-whatsapp-green text-white' : 'bg-gray-200 text-gray-600'}"
                            title="${phoneAiActive ? 'Desativar IA' : 'Ativar IA'}"
                            aria-label="${phoneAiActive ? 'Desativar IA para ' + escapeHtml(phoneNumber) : 'Ativar IA para ' + escapeHtml(phoneNumber)}">
                        <i class="ri-robot-line" aria-hidden="true"></i>
                    </button>
                    
                    <!-- Delete Button -->
                    <button onclick="confirmDeletePhone(event, ${phoneId}, '${phoneNumber.replace(/'/g, "\\'")}' )" 
                            class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-colors text-xs focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1"
                            title="Excluir número ${escapeHtml(phoneNumber)}"
                            aria-label="Excluir número ${escapeHtml(phoneNumber)}">
                        <i class="ri-delete-bin-line" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return phoneDiv;
}

function checkAndLoadMoreItems() {
    if (renderedCount >= filteredPhones.length || isRendering) return;
    
    const scrollContainer = document.getElementById('phone-list-scroll');
    const scrollTop = scrollContainer.scrollTop;
    const scrollHeight = scrollContainer.scrollHeight;
    const clientHeight = scrollContainer.clientHeight;
    
    // Load more when near bottom
    if (scrollTop + clientHeight >= scrollHeight - SCROLL_THRESHOLD) {
        renderPhoneNumbers(false);
    }
}

function filterPhoneNumbers(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    
    if (term === '') {
        filteredPhones = [...allPhones];
    } else {
        filteredPhones = allPhones.filter(phone => 
            phone.number.toLowerCase().includes(term)
        );
    }
    
    updatePhoneCount(filteredPhones.length);
    renderPhoneNumbers(true);
    
    console.log(`Filtered to ${filteredPhones.length} phones with term: "${term}"`);
}

function updatePhoneCount(count) {
    const phoneCountElement = document.getElementById('phone-count');
    phoneCountElement.textContent = count;
}

function showEmptyState() {
    const phoneList = document.getElementById('phone-list');
    const searchTerm = document.getElementById('phone-search').value.trim();
    
    const emptyMessage = searchTerm 
        ? 'Nenhum número encontrado para essa pesquisa'
        : 'Nenhum número cadastrado';
        
    const emptyIcon = searchTerm ? 'ri-search-line' : 'ri-phone-line';
    
    phoneList.innerHTML = `
        <div class="p-6 text-center text-gray-500">
            <i class="${emptyIcon} text-3xl mb-3 opacity-50"></i>
            <p class="text-sm font-medium mb-1">${emptyMessage}</p>
            ${!searchTerm ? '<p class="text-xs">Clique no + para adicionar o primeiro número</p>' : ''}
        </div>
    `;
}

function selectPhone(phoneNumber, phoneId) {
    console.log(`Selecting phone: ${phoneNumber} (ID: ${phoneId})`);
    
    selectedPhone = phoneNumber;
    
    // Update visual selection
    document.querySelectorAll('.phone-item').forEach(item => {
        item.classList.remove('bg-whatsapp-light-green');
    });
    
    const phoneItem = document.querySelector(`[data-phone="${phoneNumber}"]`);
    if (phoneItem) {
        phoneItem.classList.add('bg-whatsapp-light-green');
    }
    
    // Load messages for this phone (only on chat page)
    if (window.loadMessages) {
        window.loadMessages(phoneNumber);
    }
    
    // Update AI toggle state
    if (window.updateAIToggleState) {
        const phone = allPhones.find(p => p.number === phoneNumber);
        if (phone) {
            window.updateAIToggleState(phoneId, phone.ai_active);
        }
    }
}

async function toggleAI(event, phoneId) {
    event.stopPropagation();
    
    // Validate phoneId
    if (!phoneId || phoneId <= 0) {
        console.error('Invalid phone ID for AI toggle:', phoneId);
        showToast('Erro: ID do telefone inválido', 'error');
        return;
    }
    
    try {
        console.log(`Toggling AI for phone ID: ${phoneId}`);
        
        const response = await fetch(`/chat/toggle-ai/${phoneId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update local data
            const phone = allPhones.find(p => p.id === phoneId);
            if (phone) {
                phone.ai_active = data.new_status;
                console.log(`Updated AI status for phone ${phone.number}: ${data.new_status}`);
            }
            
            // Re-render to update UI
            renderPhoneNumbers(true);
            showToast('Status da IA alterado', 'success');
        } else {
            showToast(data.message || 'Erro ao alterar status da IA', 'error');
        }
    } catch (error) {
        console.error('Error toggling AI:', error);
        showToast('Erro ao alterar status da IA', 'error');
    }
}

function confirmDeletePhone(event, phoneId, phoneNumber) {
    event.stopPropagation();
    
    // Validate inputs
    if (!phoneId || phoneId <= 0) {
        console.error('Invalid phone ID for deletion:', phoneId);
        showToast('Erro: ID do telefone inválido', 'error');
        return;
    }
    
    if (!phoneNumber) {
        console.error('Invalid phone number for deletion:', phoneNumber);
        showToast('Erro: Número do telefone inválido', 'error');
        return;
    }
    
    deletePhoneId = phoneId;
    deletePhoneNumber = phoneNumber;
    
    // Update modal message with specific phone number
    const modal = document.getElementById('delete-phone-modal');
    const messageElement = modal.querySelector('[data-modal-content] p');
    if (messageElement) {
        messageElement.textContent = `Tem certeza que deseja excluir o número ${phoneNumber}?`;
    }
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Setup modal event listeners if not already done
    setupDeleteModalEvents();
}

// Setup delete modal events (call once)
function setupDeleteModalEvents() {
    const modal = document.getElementById('delete-phone-modal');
    if (modal.hasAttribute('data-events-setup')) {
        return; // Already setup
    }
    
    const confirmButton = modal.querySelector('[data-modal-confirm]');
    const closeButton = modal.querySelector('[data-modal-close]');
    const backdrop = modal;
    
    if (confirmButton) {
        confirmButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            deletePhone();
        });
    }
    
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            // Reset delete variables
            deletePhoneId = null;
            deletePhoneNumber = null;
        });
    }
    
    // Close modal when clicking backdrop
    backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
            modal.classList.add('hidden');
            // Reset delete variables
            deletePhoneId = null;
            deletePhoneNumber = null;
        }
    });
    
    // Mark as setup
    modal.setAttribute('data-events-setup', 'true');
}

async function deletePhone() {
    if (!deletePhoneId || deletePhoneId <= 0) {
        console.error('Invalid phone ID for deletion:', deletePhoneId);
        showToast('Erro: ID do telefone inválido', 'error');
        return;
    }
    
    try {
        console.log(`Deleting phone ID: ${deletePhoneId}`);
        
        const response = await fetch(`/chat/delete-phone/${deletePhoneId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from local data
            allPhones = allPhones.filter(p => p.id !== deletePhoneId);
            filteredPhones = filteredPhones.filter(p => p.id !== deletePhoneId);
            
            // Clear selection if deleted phone was selected
            if (selectedPhone === deletePhoneNumber) {
                selectedPhone = null;
                // Clear chat if on chat page
                if (window.clearChat) {
                    window.clearChat();
                }
            }
            
            updatePhoneCount(filteredPhones.length);
            renderPhoneNumbers(true);
            
            showToast('Número excluído com sucesso', 'success');
            console.log(`Successfully deleted phone: ${deletePhoneNumber}`);
        } else {
            showToast(data.message || 'Erro ao excluir número', 'error');
        }
    } catch (error) {
        console.error('Error deleting phone:', error);
        showToast('Erro ao excluir número', 'error');
    } finally {
        // Reset delete variables
        deletePhoneId = null;
        deletePhoneNumber = null;
    }
}

function showAddPhoneModal() {
    const modal = document.getElementById('add-phone-modal');
    modal.classList.remove('hidden');
    document.getElementById('new-phone-number').focus();
}

function hideAddPhoneModal() {
    const modal = document.getElementById('add-phone-modal');
    modal.classList.add('hidden');
    document.getElementById('new-phone-number').value = '';
}

async function addPhone(event) {
    event.preventDefault();
    
    const phoneNumber = document.getElementById('new-phone-number').value.trim();
    
    if (!phoneNumber) {
        showToast('Por favor, insira um número válido', 'error');
        return;
    }
    
    // Check if phone already exists
    if (allPhones.some(p => p.number === phoneNumber)) {
        showToast('Este número já está cadastrado', 'error');
        return;
    }
    
    try {
        console.log(`Adding phone: ${phoneNumber}`);
        
        const response = await fetch('/chat/add-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ number: phoneNumber })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add to local data
            allPhones.unshift(data.phone); // Add to beginning
            filterPhoneNumbers(document.getElementById('phone-search').value); // Re-filter
            
            hideAddPhoneModal();
            showToast('Número adicionado com sucesso', 'success');
        } else {
            showToast(data.message || 'Erro ao adicionar número', 'error');
        }
    } catch (error) {
        console.error('Error adding phone:', error);
        showToast('Erro ao adicionar número', 'error');
    }
}

async function logout() {
    try {
        const response = await fetch('/auth/logout', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            window.location.href = data.redirect;
        }
    } catch (error) {
        console.error('Error logging out:', error);
        window.location.href = '/login';
    }
}

// Utility function
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Global functions for external access
window.loadPhoneNumbers = loadPhoneNumbers;
window.selectPhone = selectPhone;
</script>