{% macro phone_item(phone, selected=false, show_actions=true) %}
<!-- Componente de Item de Telefone Reutilizável -->
{% set phone_id = phone.id|default(0) %}
{% set phone_number = phone.number|default('') %}
{% set phone_ai_active = phone.ai_active|default(false) %}
{% set phone_created_at = phone.created_at %}

<div class="phone-item border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors group {{ 'bg-whatsapp-light-green' if selected else '' }}" 
     onclick="handleSelectPhone(this)" 
     data-phone="{{ phone_number|e }}"
     data-phone-id="{{ phone_id }}"
     data-phone-number="{{ phone_number|e }}"
     role="button"
     tabindex="0"
     aria-label="Selecionar número {{ phone_number|e }}">
    <div class="p-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3 flex-1 min-w-0">
                <!-- Avatar -->
                <div class="w-10 h-10 bg-gradient-to-r from-whatsapp-green to-whatsapp-dark-green rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-xs font-medium">
                        {% if phone_number|length >= 4 %}
                            {{ phone_number[-4:] }}
                        {% else %}
                            {{ phone_number[:2] if phone_number else '??' }}
                        {% endif %}
                    </span>
                </div>
                
                <!-- Phone Info -->
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 truncate text-sm">{{ phone_number|e }}</h4>
                    <div class="flex items-center space-x-2 text-xs text-gray-500 mt-0.5">
                        <span class="flex items-center space-x-1">
                            <i class="ri-robot-line text-xs" aria-hidden="true"></i>
                            <span>{{ 'IA Ativa' if phone_ai_active else 'IA Inativa' }}</span>
                        </span>
                        <span class="w-1 h-1 bg-gray-400 rounded-full" aria-hidden="true"></span>
                        <span>
                            {% if phone_created_at %}
                                {{ phone_created_at.strftime('%d/%m') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            {% if show_actions and phone_id > 0 %}
            <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity" role="group" aria-label="Ações do número">
                <!-- AI Toggle -->
                <button onclick="handleToggleAI(event, this)" 
                        class="ai-toggle p-1.5 rounded-lg transition-colors text-xs focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:ring-offset-1
                               {{ 'bg-whatsapp-green text-white' if phone_ai_active else 'bg-gray-200 text-gray-600' }}"
                        title="{{ 'Desativar IA' if phone_ai_active else 'Ativar IA' }}"
                        aria-label="{{ ('Desativar IA para ' + phone_number) if phone_ai_active else ('Ativar IA para ' + phone_number) }}"
                        data-phone-id="{{ phone_id }}"
                        data-phone-number="{{ phone_number|e }}"
                        data-ai-active="{{ 'true' if phone_ai_active else 'false' }}">
                    <i class="ri-robot-line" aria-hidden="true"></i>
                </button>
                
                <!-- Delete Button -->
                <button onclick="handleDeletePhone(event, this)" 
                        class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-colors text-xs focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1"
                        title="Excluir número {{ phone_number|e }}"
                        aria-label="Excluir número {{ phone_number|e }}"
                        data-phone-id="{{ phone_id }}"
                        data-phone-number="{{ phone_number|e }}">
                    <i class="ri-delete-bin-line" aria-hidden="true"></i>
                </button>
            </div>
            {% elif show_actions and phone_id <= 0 %}
            <!-- Placeholder for invalid phone_id -->
            <div class="flex items-center space-x-1 opacity-50" role="group" aria-label="Ações indisponíveis">
                <span class="text-xs text-gray-400">ID inválido</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Função segura para selecionar telefone
function handleSelectPhone(element) {
    const phoneNumber = element.dataset.phoneNumber;
    const phoneId = parseInt(element.dataset.phoneId);
    
    console.log('Selecting phone:', { phoneNumber, phoneId });
    
    // Validação
    if (!phoneNumber || !phoneId || phoneId <= 0) {
        console.warn('Invalid phone data:', { phoneNumber, phoneId });
        return;
    }
    
    // Chama a função global se existir
    if (window.selectPhone && typeof window.selectPhone === 'function') {
        window.selectPhone(phoneNumber, phoneId);
    } else {
        console.error('selectPhone function not found in global scope');
    }
}

// Função segura para toggle de IA
function handleToggleAI(event, button) {
    event.stopPropagation();
    
    const phoneId = parseInt(button.dataset.phoneId);
    const phoneNumber = button.dataset.phoneNumber;
    const currentAiActive = button.dataset.aiActive === 'true';
    
    console.log('Toggle AI for phone:', { 
        phoneId, 
        phoneNumber, 
        currentState: currentAiActive 
    });
    
    // Validação
    if (!phoneId || phoneId <= 0) {
        console.error('Invalid phone ID for AI toggle:', phoneId);
        if (window.showToast && typeof window.showToast === 'function') {
            window.showToast('Erro: ID do telefone inválido', 'error');
        }
        return;
    }
    
    // Chama a função global se existir
    if (window.toggleAI && typeof window.toggleAI === 'function') {
        window.toggleAI(event, phoneId);
    } else {
        console.error('toggleAI function not found in global scope');
    }
}

// Log para debug do componente
console.log('Phone item component handlers loaded');
</script>
{% endmacro %}

{% macro phone_list(phones, loading=false, empty_message="Nenhum número cadastrado", search_term="") %}
<!-- Lista de Telefones com Estados -->
{% if loading %}
    <div class="p-4 text-center text-gray-500" role="status" aria-live="polite">
        <i class="ri-loader-4-line animate-spin text-2xl mb-2" aria-hidden="true"></i>
        <p class="text-sm">Carregando números...</p>
    </div>
{% elif phones|length == 0 %}
    <div class="p-6 text-center text-gray-500" role="status">
        {% if search_term %}
            <i class="ri-search-line text-3xl mb-3 opacity-50" aria-hidden="true"></i>
            <p class="text-sm font-medium mb-1">Nenhum número encontrado para "{{ search_term|e }}"</p>
            <p class="text-xs">Tente outro termo de busca</p>
        {% else %}
            <i class="ri-phone-line text-3xl mb-3 opacity-50" aria-hidden="true"></i>
            <p class="text-sm font-medium mb-1">{{ empty_message|e }}</p>
            <p class="text-xs">Clique no + para adicionar o primeiro número</p>
        {% endif %}
    </div>
{% else %}
    <div role="list" aria-label="Lista de números de telefone">
        {% for phone in phones %}
            <div role="listitem">
                {{ phone_item(phone) }}
            </div>
        {% endfor %}
    </div>
{% endif %}
{% endmacro %}

{% macro phone_item_skeleton(count=3) %}
<!-- Skeleton Loading para Phone Items -->
{% for i in range(count) %}
<div class="phone-item border-b border-gray-100 p-3 animate-pulse" role="status" aria-label="Carregando item {{ i + 1 }}">
    <div class="flex items-center space-x-3">
        <!-- Avatar Skeleton -->
        <div class="w-10 h-10 bg-gray-300 rounded-full flex-shrink-0"></div>
        
        <!-- Content Skeleton -->
        <div class="flex-1 space-y-2">
            <div class="h-4 bg-gray-300 rounded w-3/4"></div>
            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
        </div>
        
        <!-- Actions Skeleton -->
        <div class="flex space-x-1">
            <div class="w-6 h-6 bg-gray-300 rounded"></div>
            <div class="w-6 h-6 bg-gray-300 rounded"></div>
        </div>
    </div>
</div>
{% endfor %}
{% endmacro %}