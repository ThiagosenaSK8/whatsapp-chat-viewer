{% extends "base/main.html" %}

{% block title %}Configura√ß√µes - WhatsApp Chat Viewer{% endblock %}

{% block content %}
<div class="flex-1 flex flex-col bg-gray-50 min-h-0">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 p-3 sm:p-4 lg:p-6 flex-shrink-0">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
            <div class="flex items-center space-x-3 min-w-0">
                <!-- Mobile menu button -->
                <button onclick="openMobileSidebar()" 
                        class="lg:hidden p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0">
                    <i class="ri-menu-line text-xl"></i>
                </button>
                
                <div class="min-w-0">
                    <h1 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900">Configura√ß√µes</h1>
                    <p class="text-sm lg:text-base text-gray-600 mt-1">Gerencie webhook, banco de dados e visualize logs do sistema</p>
                </div>
            </div>
            <div class="flex items-center flex-shrink-0">
                <button onclick="refreshAllStatus()" 
                        class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-whatsapp-green text-white rounded-lg hover:bg-whatsapp-dark-green transition-colors text-sm lg:text-base">
                    <i class="ri-refresh-line mr-1 sm:mr-2"></i>
                    <span class="hidden xs:inline">Atualizar Status</span>
                    <span class="xs:hidden">Atualizar</span>
                </button>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 lg:p-6 space-y-6 lg:space-y-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
            <!-- Webhook Status Card -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 lg:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="ri-webhook-line text-blue-600 text-lg lg:text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-sm lg:text-base font-semibold text-gray-900">Webhook</h3>
                            <p class="text-xs lg:text-sm text-gray-500">Status da conex√£o</p>
                        </div>
                    </div>
                    <div id="webhook-status-indicator" class="w-3 h-3 bg-gray-400 rounded-full flex-shrink-0"></div>
                </div>
                <div id="webhook-status-text" class="text-sm text-gray-600 mb-3">Verificando...</div>
                <div id="webhook-details" class="text-xs text-gray-500 break-words mb-3"></div>
                
                <!-- Configuration Details -->
                <div id="config-details" class="mb-3 p-2 rounded bg-blue-50 hidden">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-blue-700">Fonte da Configura√ß√£o:</span>
                        <span id="config-source" class="text-xs font-bold"></span>
                    </div>
                    <div id="config-recommendation" class="text-xs text-blue-600 mt-1"></div>
                    <div id="config-conflict" class="text-xs text-red-600 mt-1 hidden"></div>
                </div>
                
                <!-- Circuit Breaker Info -->
                <div id="circuit-breaker-info" class="mb-3 p-2 rounded bg-gray-50 hidden">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-gray-700">Circuit Breaker:</span>
                        <span id="circuit-status" class="text-xs"></span>
                    </div>
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-xs text-gray-600">Falhas:</span>
                        <span id="failure-count" class="text-xs"></span>
                    </div>
                </div>
                
                <!-- Webhook Controls -->
                <div class="flex flex-wrap gap-2 mb-2">
                    <button onclick="resetCircuitBreaker()" 
                            id="reset-circuit-btn"
                            class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded hover:bg-yellow-200 transition-colors hidden">
                        üîÑ Reset Circuit
                    </button>
                </div>
                
                <!-- Webhook Test Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="testWebhook('image')" 
                            class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 transition-colors">
                        üñºÔ∏è Testar Imagem
                    </button>
                    <button onclick="testWebhook('pdf')" 
                            class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded hover:bg-red-200 transition-colors">
                        üìÑ Testar PDF
                    </button>
                    <button onclick="testWebhook('document')" 
                            class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded hover:bg-green-200 transition-colors">
                        üìù Testar Doc
                    </button>
                    <button onclick="testWebhook('audio')" 
                            class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded hover:bg-purple-200 transition-colors">
                        üéµ Testar √Åudio
                    </button>
                    <button onclick="testWebhook('video')" 
                            class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded hover:bg-orange-200 transition-colors">
                        üé¨ Testar V√≠deo
                    </button>
                </div>
            </div>

            <!-- Database Status Card -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 lg:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="ri-database-line text-green-600 text-lg lg:text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-sm lg:text-base font-semibold text-gray-900">Banco de Dados</h3>
                            <p class="text-xs lg:text-sm text-gray-500">Status da conex√£o</p>
                        </div>
                    </div>
                    <div id="db-status-indicator" class="w-3 h-3 bg-gray-400 rounded-full flex-shrink-0"></div>
                </div>
                <div id="db-status-text" class="text-sm text-gray-600 mb-3">Verificando...</div>
                <div id="db-details" class="text-xs text-gray-500 break-words"></div>
            </div>
        </div>

        <!-- Webhook Configuration Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4 lg:p-6 border-b border-gray-200">
                <h3 class="text-base lg:text-lg font-semibold text-gray-900 flex items-center">
                    <i class="ri-settings-line mr-2"></i>
                    Configura√ß√£o do Webhook
                </h3>
                <p class="text-sm text-gray-600 mt-1">Configure a URL do webhook para envio de mensagens</p>
            </div>
            <div class="p-4 lg:p-6">
                <form id="webhook-form" onsubmit="updateWebhookConfig(event)">
                    <div class="space-y-4">
                        <div>
                            <label for="webhook-url" class="block text-sm font-medium text-gray-700 mb-2">
                                URL do Webhook
                            </label>
                            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                                <input type="url" 
                                       id="webhook-url" 
                                       name="webhook_url"
                                       placeholder="https://api.example.com/webhook/..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:border-transparent text-sm"
                                       required>
                                <div class="flex space-x-2">
                                    <button type="button" 
                                            onclick="testWebhook()"
                                            class="flex-1 sm:flex-none px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                        <i class="ri-play-line mr-1"></i>
                                        <span class="hidden sm:inline">Testar</span>
                                        <span class="sm:hidden">Test</span>
                                    </button>
                                    <button type="submit" 
                                            class="flex-1 sm:flex-none px-4 py-2 bg-whatsapp-green text-white rounded-lg hover:bg-whatsapp-dark-green transition-colors text-sm">
                                        <i class="ri-save-line mr-1"></i>
                                        <span class="hidden sm:inline">Salvar</span>
                                        <span class="sm:hidden">Save</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="webhook-test-result" class="hidden p-3 rounded-lg text-sm"></div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4 lg:p-6 border-b border-gray-200">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                    <div>
                        <h3 class="text-base lg:text-lg font-semibold text-gray-900 flex items-center">
                            <i class="ri-file-list-line mr-2"></i>
                            Logs do Sistema
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">Visualize logs de atividades e erros do sistema</p>
                    </div>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                        <select id="log-level" 
                                onchange="loadLogs()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:border-transparent text-sm">
                            <option value="all">Todos os N√≠veis</option>
                            <option value="INFO">Info</option>
                            <option value="WARNING">Warning</option>
                            <option value="ERROR">Error</option>
                        </select>
                        <select id="log-lines" 
                                onchange="loadLogs()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:border-transparent text-sm">
                            <option value="50">50 linhas</option>
                            <option value="100" selected>100 linhas</option>
                            <option value="200">200 linhas</option>
                            <option value="500">500 linhas</option>
                        </select>
                        <div class="flex space-x-2">
                            <button onclick="loadLogs()" 
                                    class="flex-1 sm:flex-none px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                <i class="ri-refresh-line"></i>
                            </button>
                            <button onclick="clearLogs()" 
                                    class="flex-1 sm:flex-none px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 lg:p-6">
                <div id="logs-container" class="bg-gray-900 text-green-400 rounded-lg p-4 h-64 sm:h-80 lg:h-96 overflow-y-auto font-mono text-xs sm:text-sm custom-scrollbar">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <i class="ri-loader-4-line animate-spin text-xl mr-2"></i>
                        Carregando logs...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-save and persistence system
let autoSaveInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize page with delay to ensure proper loading
    setTimeout(() => {
        loadWebhookConfig();
        loadDatabaseStatus();
        loadLogs();
    }, 500);
    
    // Setup auto-refresh for logs every 30 seconds
    setInterval(() => {
        const container = document.getElementById('logs-container');
        if (container && !container.innerHTML.includes('Carregando')) {
            loadLogs();
        }
    }, 30000);
    
    // Add webhook input validation
    const webhookInput = document.getElementById('webhook-url');
    webhookInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value && !value.match(/^https?:\/\/.+/)) {
            this.classList.add('border-red-300', 'focus:ring-red-500', 'focus:border-red-500');
            this.classList.remove('border-gray-300', 'focus:ring-whatsapp-green', 'focus:border-transparent');
        } else {
            this.classList.remove('border-red-300', 'focus:ring-red-500', 'focus:border-red-500');
            this.classList.add('border-gray-300', 'focus:ring-whatsapp-green', 'focus:border-transparent');
        }
    });
});

async function loadWebhookConfig() {
    try {
        // Show loading state
        document.getElementById('webhook-status-text').textContent = 'Carregando...';
        document.getElementById('webhook-details').textContent = '';
        
        // Load both webhook config and status
        const [configResponse, statusResponse] = await Promise.all([
            fetch('/settings/webhook-config?_=' + Date.now()),
            fetch('/chat/webhook-status?_=' + Date.now())
        ]);
        
        const configData = await configResponse.json();
        const statusData = await statusResponse.json();
        
        if (configData.success) {
            const config = configData.config;
            const webhookInput = document.getElementById('webhook-url');
            
            // Only update input if it's different to avoid cursor jumping
            if (webhookInput.value !== config.webhook_url) {
                webhookInput.value = config.webhook_url || '';
            }
            
            updateWebhookStatusDisplay(config.webhook_status);
            
            // Show detailed configuration info
            if (config.config_details) {
                const details = config.config_details;
                updateConfigurationDetails({
                    config_source: details.source,
                    has_conflict: details.has_conflict,
                    env_value: details.env_url,
                    interface_value: details.file_url,
                    recommendation: details.recommendation
                });
            }
            
            if (config.webhook_url) {
                console.log('Webhook configuration loaded:', config.webhook_url);
            }
        } else {
            updateWebhookStatusDisplay({
                status: 'error',
                message: 'Erro ao carregar configura√ß√£o'
            });
        }
        
        // Update circuit breaker info if status data is available
        if (statusData.success) {
            updateCircuitBreakerDisplay(statusData);
        }
        
    } catch (error) {
        console.error('Error loading webhook config:', error);
        updateWebhookStatusDisplay({
            status: 'error',
            message: 'Erro de conex√£o'
        });
    }
}

async function loadDatabaseStatus() {
    try {
        // Show loading state
        document.getElementById('db-status-text').textContent = 'Verificando...';
        
        const response = await fetch('/settings/database-status?_=' + Date.now());
        const data = await response.json();
        
        if (data.success) {
            updateDatabaseStatusDisplay(data.status);
        } else {
            updateDatabaseStatusDisplay({
                connected: false,
                status: 'Erro',
                database_url: 'Erro ao verificar'
            });
        }
    } catch (error) {
        console.error('Error loading database status:', error);
        updateDatabaseStatusDisplay({
            connected: false,
            status: 'Erro de conex√£o',
            database_url: 'N√£o dispon√≠vel'
        });
    }
}

async function loadLogs() {
    const level = document.getElementById('log-level').value;
    const lines = document.getElementById('log-lines').value;
    
    try {
        const response = await fetch(`/settings/logs?level=${level}&lines=${lines}&_=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            displayLogs(data.logs);
        } else {
            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="text-center text-red-400">Erro ao carregar logs</div>';
        }
    } catch (error) {
        console.error('Error loading logs:', error);
        const container = document.getElementById('logs-container');
        container.innerHTML = '<div class="text-center text-red-400">Erro de conex√£o</div>';
    }
}

async function updateWebhookConfig(event) {
    event.preventDefault();
    
    const webhookUrl = document.getElementById('webhook-url').value.trim();
    
    if (!webhookUrl) {
        showToast('Por favor, digite uma URL v√°lida', 'warning');
        return;
    }
    
    if (!webhookUrl.match(/^https?:\/\/.+/)) {
        showToast('URL deve come√ßar com http:// ou https://', 'warning');
        return;
    }
    
    // Show loading state
    const submitButton = event.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="ri-loader-4-line animate-spin mr-1"></i>Salvando...';
    submitButton.disabled = true;
    
    try {
        const response = await fetch('/settings/webhook-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ webhook_url: webhookUrl })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Configura√ß√£o salva com sucesso!', 'success');
            updateWebhookStatusDisplay(data.webhook_status);
            
            // Confirm persistence with a delayed reload
            setTimeout(() => {
                loadWebhookConfig();
            }, 1500);
        } else {
            showToast(data.message || 'Erro ao salvar configura√ß√£o', 'error');
        }
    } catch (error) {
        console.error('Error updating webhook config:', error);
        showToast('Erro ao salvar configura√ß√£o', 'error');
    } finally {
        // Reset button state
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
}

async function testWebhook() {
    const webhookUrl = document.getElementById('webhook-url').value.trim();
    
    if (!webhookUrl) {
        showToast('Digite a URL do webhook primeiro', 'warning');
        return;
    }
    
    if (!webhookUrl.match(/^https?:\/\/.+/)) {
        showToast('URL deve ter formato v√°lido (http:// ou https://)', 'warning');
        return;
    }
    
    const resultDiv = document.getElementById('webhook-test-result');
    resultDiv.className = 'p-3 rounded-lg bg-blue-50 border border-blue-200 text-sm';
    resultDiv.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Testando conectividade...';
    resultDiv.classList.remove('hidden');
    
    try {
        const response = await fetch('/settings/test-webhook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ webhook_url: webhookUrl })
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateWebhookTestResult(data.webhook_status);
            updateWebhookStatusDisplay(data.webhook_status);
        } else {
            resultDiv.className = 'p-3 rounded-lg bg-red-50 border border-red-200 text-sm';
            resultDiv.innerHTML = `<i class="ri-close-line mr-2 text-red-600"></i>${data.message}`;
        }
    } catch (error) {
        console.error('Error testing webhook:', error);
        resultDiv.className = 'p-3 rounded-lg bg-red-50 border border-red-200 text-sm';
        resultDiv.innerHTML = '<i class="ri-close-line mr-2 text-red-600"></i>Erro ao testar webhook';
    }
}

function updateWebhookStatusDisplay(status) {
    const indicator = document.getElementById('webhook-status-indicator');
    const text = document.getElementById('webhook-status-text');
    const details = document.getElementById('webhook-details');
    
    switch (status.status) {
        case 'online':
            indicator.className = 'w-3 h-3 bg-green-500 rounded-full flex-shrink-0';
            text.textContent = '‚úÖ Online';
            details.textContent = `${status.message} (${status.response_time}s)`;
            break;
        case 'offline':
            indicator.className = 'w-3 h-3 bg-red-500 rounded-full flex-shrink-0';
            text.textContent = '‚ùå Offline';
            details.textContent = status.message;
            break;
        case 'timeout':
            indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full flex-shrink-0';
            text.textContent = '‚è±Ô∏è Timeout';
            details.textContent = status.message;
            break;
        case 'error':
            indicator.className = 'w-3 h-3 bg-red-500 rounded-full flex-shrink-0';
            text.textContent = '‚ùå Erro';
            details.textContent = status.message;
            break;
        case 'not_configured':
            indicator.className = 'w-3 h-3 bg-gray-400 rounded-full flex-shrink-0';
            text.textContent = '‚ö™ N√£o Configurado';
            details.textContent = status.message;
            break;
        default:
            indicator.className = 'w-3 h-3 bg-gray-400 rounded-full flex-shrink-0';
            text.textContent = '‚ùì Desconhecido';
            details.textContent = status.message || 'Status desconhecido';
    }
}

function updateDatabaseStatusDisplay(status) {
    const indicator = document.getElementById('db-status-indicator');
    const text = document.getElementById('db-status-text');
    const details = document.getElementById('db-details');
    
    if (status.connected) {
        indicator.className = 'w-3 h-3 bg-green-500 rounded-full';
        text.textContent = 'Conectado';
        details.textContent = `Banco: ${status.database_url}`;
    } else {
        indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
        text.textContent = 'Desconectado';
        details.textContent = 'Falha na conex√£o com o banco de dados';
    }
}

function updateWebhookTestResult(status) {
    const resultDiv = document.getElementById('webhook-test-result');
    
    switch (status.status) {
        case 'online':
            resultDiv.className = 'p-3 rounded-lg bg-green-50 border border-green-200';
            resultDiv.innerHTML = `<i class="ri-check-line mr-2 text-green-600"></i>Webhook online - Resposta em ${status.response_time}s`;
            break;
        case 'offline':
            resultDiv.className = 'p-3 rounded-lg bg-red-50 border border-red-200';
            resultDiv.innerHTML = `<i class="ri-close-line mr-2 text-red-600"></i>Webhook offline - ${status.message}`;
            break;
        case 'timeout':
            resultDiv.className = 'p-3 rounded-lg bg-yellow-50 border border-yellow-200';
            resultDiv.innerHTML = `<i class="ri-time-line mr-2 text-yellow-600"></i>Timeout - ${status.message}`;
            break;
        default:
            resultDiv.className = 'p-3 rounded-lg bg-red-50 border border-red-200';
            resultDiv.innerHTML = `<i class="ri-alert-line mr-2 text-red-600"></i>Erro - ${status.message}`;
    }
}

function displayLogs(logs) {
    const container = document.getElementById('logs-container');
    
    if (!logs || logs.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500">üìã Nenhum log encontrado</div>';
        return;
    }
    
    const logsHtml = logs.map(log => {
        const timestamp = new Date(log.timestamp).toLocaleString('pt-BR');
        let levelColor = 'text-green-400';
        let levelIcon = 'üí¨';
        
        switch (log.level) {
            case 'WARNING':
                levelColor = 'text-yellow-400';
                levelIcon = '‚ö†Ô∏è';
                break;
            case 'ERROR':
                levelColor = 'text-red-400';
                levelIcon = '‚ùå';
                break;
            case 'INFO':
                levelColor = 'text-blue-400';
                levelIcon = '‚ÑπÔ∏è';
                break;
        }
        
        return `
            <div class="mb-1 font-mono text-xs hover:bg-gray-800 p-1 rounded">
                <span class="text-gray-400">[${timestamp}]</span>
                <span class="${levelColor} font-bold">${levelIcon} ${log.level}</span>
                <span class="text-gray-300">[${log.module}]</span>
                <span class="text-green-300">${log.message}</span>
            </div>
        `;
    }).join('');
    
    container.innerHTML = logsHtml;
    container.scrollTop = container.scrollHeight;
}

async function refreshAllStatus() {
    const refreshButton = event.target;
    const originalText = refreshButton.innerHTML;
    refreshButton.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Atualizando...';
    refreshButton.disabled = true;
    
    try {
        showToast('üîÑ Atualizando todos os status...', 'info', 2000);
        
        // Load all data in parallel
        await Promise.all([
            loadWebhookConfig(),
            loadDatabaseStatus(),
            loadLogs()
        ]);
        
        showToast('‚úÖ Status atualizado com sucesso!', 'success');
    } catch (error) {
        showToast('‚ùå Erro ao atualizar status', 'error');
    } finally {
        refreshButton.innerHTML = originalText;
        refreshButton.disabled = false;
    }
}

async function testWebhook(attachmentType) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = `‚è≥ Testando...`;
    
    try {
        console.log(`Testing webhook for attachment type: ${attachmentType}`);
        
        // Create AbortController for timeout (6 seconds for tests)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 6000);
        
        const response = await fetch('/chat/test-webhook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: 'test-number',
                attachment_type: attachmentType
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const result = await response.json();
        
        if (result.success) {
            if (result.webhook_sent) {
                showToast(`‚úÖ Webhook ${attachmentType} enviado com sucesso!`, 'success');
                button.innerHTML = `‚úÖ ${originalText.split(' ')[1]}`;
            } else {
                showToast(`‚ö†Ô∏è Webhook ${attachmentType} n√£o foi enviado (verifique URL)`, 'warning');
                button.innerHTML = `‚ö†Ô∏è ${originalText.split(' ')[1]}`;
            }
        } else {
            showToast(`‚ùå Erro ao testar webhook ${attachmentType}: ${result.message}`, 'error');
            button.innerHTML = `‚ùå ${originalText.split(' ')[1]}`;
        }
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
        
        // Refresh logs after test
        setTimeout(() => {
            loadLogs();
        }, 1000);
        
    } catch (error) {
        console.error(`Error testing webhook for ${attachmentType}:`, error);
        
        let errorMessage = `‚ùå Erro de conex√£o ao testar webhook ${attachmentType}`;
        if (error.name === 'AbortError') {
            errorMessage = `‚è∞ Timeout ao testar webhook ${attachmentType} (6s)`;
        }
        
        showToast(errorMessage, 'error');
        button.innerHTML = `‚ùå ${originalText.split(' ')[1]}`;
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    } finally {
        button.disabled = false;
    }
}

        function updateConfigurationDetails(data) {
            const detailsDiv = document.getElementById('config-details');
            const sourceSpan = document.getElementById('config-source');
            const recommendationDiv = document.getElementById('config-recommendation');
            const conflictDiv = document.getElementById('config-conflict');

            if (data.config_source) {
                detailsDiv.classList.remove('hidden');
                
                // Definir fonte da configura√ß√£o
                sourceSpan.textContent = data.config_source === 'interface' ? 'Interface' : data.config_source === 'env' ? '.env' : 'Nenhuma';
                sourceSpan.className = data.config_source === 'interface' 
                    ? 'text-xs font-bold text-green-600' 
                    : data.config_source === 'env' 
                    ? 'text-xs font-bold text-blue-600'
                    : 'text-xs font-bold text-gray-600';

                // Mostrar recomenda√ß√£o
                if (data.config_source === 'interface') {
                    recommendationDiv.textContent = 'Configura√ß√£o via interface (perfeito para produ√ß√£o). F√°cil de alterar quando necess√°rio.';
                } else if (data.config_source === 'env') {
                    recommendationDiv.textContent = 'Configura√ß√£o via .env (desenvolvimento local). Configure via interface para facilitar mudan√ßas.';
                } else {
                    recommendationDiv.textContent = 'Nenhuma configura√ß√£o definida. Configure via interface para melhor experi√™ncia.';
                }

                // Mostrar conflito se houver
                if (data.has_conflict) {
                    conflictDiv.classList.remove('hidden');
                    conflictDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-1">‚ÑπÔ∏è</span>
                            <span>Vari√°vel de ambiente detectada, mas usando configura√ß√£o da interface</span>
                        </div>
                        <div class="ml-4 text-xs">
                            <div>‚Ä¢ Interface (ativo): ${data.interface_value || 'n√£o definido'}</div>
                            <div>‚Ä¢ .env (inativo): ${data.env_value || 'n√£o definido'}</div>
                        </div>
                        <div class="ml-4 text-xs mt-1 text-blue-600">
                            Interface tem prioridade (ideal para produ√ß√£o)
                        </div>
                    `;
                } else {
                    conflictDiv.classList.add('hidden');
                }
            } else {
                detailsDiv.classList.add('hidden');
            }
        }

        function updateCircuitBreakerDisplay(statusData) {
    const container = document.getElementById('circuit-breaker-info');
    const statusElement = document.getElementById('circuit-status');
    const failureCountElement = document.getElementById('failure-count');
    const resetButton = document.getElementById('reset-circuit-btn');
    
    if (statusData.failure_count > 0 || statusData.circuit_broken) {
        container.classList.remove('hidden');
        
        // Update status
        if (statusData.circuit_broken) {
            statusElement.textContent = 'üî¥ Ativo';
            statusElement.className = 'text-xs font-bold text-red-600';
            resetButton.classList.remove('hidden');
        } else {
            statusElement.textContent = 'üü° Monitorando';
            statusElement.className = 'text-xs font-bold text-yellow-600';
            resetButton.classList.add('hidden');
        }
        
        // Update failure count
        failureCountElement.textContent = `${statusData.failure_count}/${statusData.max_failures}`;
        
        // Show time since last failure
        if (statusData.time_since_last_failure !== null) {
            const minutes = Math.floor(statusData.time_since_last_failure / 60);
            const seconds = statusData.time_since_last_failure % 60;
            const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            failureCountElement.textContent += ` (h√° ${timeStr})`;
        }
    } else {
        container.classList.add('hidden');
        resetButton.classList.add('hidden');
    }
}

async function resetCircuitBreaker() {
    const button = document.getElementById('reset-circuit-btn');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '‚è≥ Resetando...';
    
    try {
        const response = await fetch('/chat/reset-webhook-circuit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('‚úÖ Circuit breaker resetado com sucesso!', 'success');
            button.innerHTML = '‚úÖ Resetado';
            setTimeout(() => {
                loadWebhookConfig(); // Reload to update display
            }, 1000);
        } else {
            showToast(`‚ùå Erro ao resetar: ${result.message}`, 'error');
            button.innerHTML = '‚ùå Erro';
        }
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
        
    } catch (error) {
        console.error('Error resetting circuit breaker:', error);
        showToast('‚ùå Erro de conex√£o', 'error');
        button.innerHTML = '‚ùå Erro';
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    } finally {
        button.disabled = false;
    }
}
</script>
{% endblock %}